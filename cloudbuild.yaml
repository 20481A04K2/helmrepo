substitutions:
  _REGION: asia-southeast1
  _CLUSTER_NAME: helm-cluster
  _HELM_RELEASE_NAME: myapp-release
  _NAMESPACE: default

steps:
  # Step 1: Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'asia-southeast1-docker.pkg.dev/thematic-land-477215-a5/helm-demo-repo/myapp:$SHORT_SHA'
      - '.'
    id: 'build-image'

  # Step 2: Push Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'asia-southeast1-docker.pkg.dev/thematic-land-477215-a5/helm-demo-repo/myapp:$SHORT_SHA'
    id: 'push-image'
    waitFor: ['build-image']

  # Step 3: Update values.yaml dynamically
  - name: 'ubuntu'
    args:
      - 'bash'
      - '-c'
      - |
        echo "Updating values.yaml with PROJECT_ID: thematic-land-477215-a5"
        sed -i "s/PROJECT_ID/thematic-land-477215-a5/g" helm/myapp/values.yaml
        echo "Updated values.yaml:"
        cat helm/myapp/values.yaml
    id: 'update-values'

  # Step 4: Get GKE credentials
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'container'
      - 'clusters'
      - 'get-credentials'
      - '${_CLUSTER_NAME}'
      - '--region'
      - '${_REGION}'
      - '--project'
      - 'thematic-land-477215-a5'
    id: 'get-credentials'
    waitFor: ['push-image']

# Step 5: Deploy Helm chart via Jumpbox VM (Modified)
Â  - name: 'gcr.io/cloud-builders/gcloud'
Â  Â  entrypoint: 'bash'
Â  Â  args:
Â  Â  Â  - '-c'
Â  Â  Â  - |
Â  Â  Â  Â  echo "Copying Helm chart to Jumpbox VM..."
Â  Â  Â  Â  # ðŸ’¡ FIX 1: Copy the entire directory 'helm/myapp' to '/tmp/' on the VM.
Â  Â  Â  Â  gcloud compute scp --recurse helm/myapp vij1542044@jumpbox-cluster:/tmp/ \
Â  Â  Â  Â  Â  --zone=asia-southeast1-c \
Â  Â  Â  Â  Â  --project=thematic-land-477215-a5 \
Â  Â  Â  Â  Â  --quiet \
Â  Â  Â  Â  Â  --ssh-flag="-o StrictHostKeyChecking=no" \
Â  Â  Â  Â  Â  --ssh-flag="-o UserKnownHostsFile=/dev/null"

Â  Â  Â  Â  echo "Deploying Helm chart via Jumpbox VM..."
Â  Â  Â  Â  gcloud compute ssh vij1542044@jumpbox-cluster \
Â  Â  Â  Â  Â  --zone=asia-southeast1-c \
Â  Â  Â  Â  Â  --project=thematic-land-477215-a5 \
Â  Â  Â  Â  Â  --quiet \
Â  Â  Â  Â  Â  --ssh-flag="-o StrictHostKeyChecking=no" \
Â  Â  Â  Â  Â  --ssh-flag="-o UserKnownHostsFile=/dev/null" \
Â  Â  Â  Â  Â  --command "
Â  Â  Â  Â  Â  Â  set -e
Â  Â  Â  Â  Â  Â  sudo bash -c '
Â  Â  Â  Â  Â  Â  Â  echo Installing Helm...
Â  Â  Â  Â  Â  Â  Â  curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

Â  Â  Â  Â  Â  Â  Â  echo Preparing Helm directory...
Â  Â  Â  Â  Â  Â  Â  # ðŸ’¡ REMOVE unnecessary copy, we can work directly in the copied chart directory
Â  Â  Â  Â  Â  Â  Â  CHART_DIR=/tmp/myapp # ðŸ’¡ NEW: Chart is now copied to /tmp/myapp/

Â  Â  Â  Â  Â  Â  Â  echo Checking chart structure:
Â  Â  Â  Â  Â  Â  Â  ls -R \${CHART_DIR} # ðŸ’¡ Use the correct path

Â  Â  Â  Â  Â  Â  Â  echo Helm version:
Â  Â  Â  Â  Â  Â  Â  helm version

Â  Â  Â  Â  Â  Â  Â  echo Deploying Helm chart...
Â  Â  Â  Â  Â  Â  Â  cd \${CHART_DIR} # ðŸ’¡ CD into the correct chart directory
Â  Â  Â  Â  Â  Â  Â  helm upgrade ${_HELM_RELEASE_NAME} . \
Â  Â  Â  Â  Â  Â  Â  Â  --install \
Â  Â  Â  Â  Â  Â  Â  Â  --create-namespace \
Â  Â  Â  Â  Â  Â  Â  Â  --namespace ${_NAMESPACE} \
Â  Â  Â  Â  Â  Â  Â  Â  --wait \
Â  Â  Â  Â  Â  Â  Â  Â  --timeout 10m \
Â  Â  Â  Â  Â  Â  Â  Â  --set image.repository=asia-southeast1-docker.pkg.dev/thematic-land-477215-a5/helm-demo-repo/myapp \
Â  Â  Â  Â  Â  Â  Â  Â  --set image.tag=$SHORT_SHA \
Â  Â  Â  Â  Â  Â  Â  Â  --set env.APP_VERSION=v1.0.0-$SHORT_SHA \
Â  Â  Â  Â  Â  Â  Â  Â  --kubeconfig /root/.kube/config \
Â  Â  Â  Â  Â  Â  Â  Â  --debug

Â  Â  Â  Â  Â  Â  Â  echo Deployment complete!
Â  Â  Â  Â  Â  Â  '
Â  Â  Â  Â  Â  "
Â  Â  id: 'helm-deploy'
Â  Â  waitFor: ['get-credentials', 'update-values']

  # Step 6: Verify deployment
  - name: 'gcr.io/cloud-builders/kubectl'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    args:
      - 'get'
      - 'all'
      - '-n'
      - '${_NAMESPACE}'
      - '-l'
      - 'app=myapp'
    id: 'verify-deployment'
    waitFor: ['helm-deploy']

  # Step 7: Get LoadBalancer IP
  - name: 'gcr.io/cloud-builders/kubectl'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=${_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
    args:
      - 'get'
      - 'svc'
      - 'myapp-service'
      - '-n'
      - '${_NAMESPACE}'
      - '-o'
      - 'wide'
    id: 'get-service'
    waitFor: ['verify-deployment']

options:
  logging: CLOUD_LOGGING_ONLY
  dynamic_substitutions: true

timeout: '1800s'
